[build]
builder = "NIXPACKS"

# Pass these environment variables as build arguments
[build.buildArgs]
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY = "${{NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}}"
CLERK_SECRET_KEY = "${{CLERK_SECRET_KEY}}"

[deploy]
numReplicas = 1
startCommand = "node server.js"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3

# Health check configuration
[[deploy.healthcheck]]
path = "/health"
interval = 30
timeout = 10
startPeriod = 40
retries = 3

# Ensure Railway uses the correct port for health checks
# Railway injects PORT automatically, but we need to ensure it's used

# Resource limits to prevent crashes
[[deploy.resourceLimits]]
memory = 2048  # 2GB RAM
cpu = 2        # 2 vCPUs

# Environment variables
[deploy.env]
NODE_ENV = "production"
NEXT_TELEMETRY_DISABLED = "1"
COOKIES_UPLOAD_DIR = "./uploads"
